<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historial de Ventas ‚Äì La Blueseria</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div id="toast-container"></div>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <svg viewBox="0 0 42 42" fill="none" width="36">
                    <circle cx="21" cy="21" r="20" fill="#1a0d04" stroke="#c8a86a" stroke-width="1.5" />
                    <path d="M16 12 L16 28 Q16 31 19 31 Q22 31 22 28 L22 22 L30 20 L30 14 L22 16 L22 12 Z"
                        fill="#c8820a" />
                    <circle cx="19" cy="30" r="2.5" fill="#f0b830" />
                </svg>
                <span>La <span style="color:var(--cyan)">Blue</span>seria</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-label">Principal</div>
                <a href="dashboard.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>Dashboard</a>
                <a href="pos.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>Punto de Venta</a>
                <div class="nav-section-label">Reportes</div>
                <a href="ventas.html" class="nav-item active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                    </svg>Historial Ventas</a>
                <a href="reportes.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                    </svg>Reportes</a>
                <div class="nav-section-label">Gesti√≥n</div>
                <a href="productos.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
                        <line x1="7" y1="7" x2="7.01" y2="7" />
                    </svg>Productos</a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar"><span id="sidebar-avatar-init">A</span></div>
                    <div>
                        <div class="sidebar-user-name" id="sidebar-user-name">‚Äì</div>
                        <div class="sidebar-user-role" id="sidebar-user-role">‚Äì</div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;">üö™
                    Cerrar sesi√≥n</button>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-title">üìã Historial de Ventas</div>
                <div class="topbar-right">
                    <span class="topbar-time" id="topbar-time"></span>
                    <button onclick="exportCSV()" class="btn btn-outline btn-sm">‚¨á Exportar CSV</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Tabs -->
                <div
                    style="display:flex;gap:8px;margin-bottom:24px;border-bottom:1px solid var(--glass-border);padding-bottom:16px;">
                    <button class="btn btn-primary btn-sm" id="tab-ventas" onclick="showTab('ventas')">üìã
                        Ventas</button>
                    <button class="btn btn-ghost btn-sm" id="tab-vendedores" onclick="showTab('vendedores')">üë• Por
                        Vendedor</button>
                </div>

                <!-- Ventas Tab -->
                <div id="panel-ventas">
                    <div class="filter-row">
                        <div class="form-group">
                            <label class="form-label">Desde</label>
                            <input class="form-control" type="date" id="filter-from" style="width:auto;" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hasta</label>
                            <input class="form-control" type="date" id="filter-to" style="width:auto;" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendedor</label>
                            <select class="form-control" id="filter-seller" style="width:auto;">
                                <option value="">Todos</option>
                                <option>Carlos P√©rez</option>
                                <option>Mar√≠a L√≥pez</option>
                                <option>Juan Torres</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√©todo pago</label>
                            <select class="form-control" id="filter-pay" style="width:auto;">
                                <option value="">Todos</option>
                                <option>Efectivo</option>
                                <option>Tarjeta</option>
                                <option>Transferencia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-primary btn-sm" onclick="applyFilters()">Filtrar</button>
                                <button class="btn btn-ghost btn-sm" onclick="clearFilters()">Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary row -->
                    <div style="display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;" id="filter-summary">
                        <div class="card-elevated" style="padding:14px 20px;flex:1;min-width:140px;text-align:center;">
                            <div class="text-muted" style="font-size:0.75rem;margin-bottom:4px;">TOTAL MOSTRADO</div>
                            <div class="fw-bold text-cyan" id="sum-total" style="font-size:1.2rem;">$0</div>
                        </div>
                        <div class="card-elevated" style="padding:14px 20px;flex:1;min-width:140px;text-align:center;">
                            <div class="text-muted" style="font-size:0.75rem;margin-bottom:4px;">N¬∫ VENTAS</div>
                            <div class="fw-bold" id="sum-count" style="font-size:1.2rem;">0</div>
                        </div>
                        <div class="card-elevated" style="padding:14px 20px;flex:1;min-width:140px;text-align:center;">
                            <div class="text-muted" style="font-size:0.75rem;margin-bottom:4px;">TICKET PROMEDIO</div>
                            <div class="fw-bold" id="sum-avg" style="font-size:1.2rem;">$0</div>
                        </div>
                    </div>

                    <div class="table-wrap card-elevated" style="padding:0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha & Hora</th>
                                    <th>Vendedor</th>
                                    <th>Productos</th>
                                    <th>Total</th>
                                    <th>Pago</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="sales-tbody"></tbody>
                        </table>
                    </div>

                    <div style="display:flex;justify-content:center;gap:8px;margin-top:16px;" id="pagination"></div>
                </div>

                <!-- Vendedores Tab -->
                <div id="panel-vendedores" class="hidden">
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:32px;"
                        id="seller-cards"></div>
                    <div class="charts-grid" style="grid-template-columns:1fr;">
                        <div class="chart-card">
                            <div class="chart-title">Ventas por vendedor ‚Äî Este mes</div>
                            <div class="chart-subtitle">Total en pesos</div>
                            <div class="chart-container"><canvas id="sellerChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script>
        requireAuth();
        populateSidebar();
        startClock();

        let allSales = getSales();
        let filtered = [...allSales];
        let currentPage = 1;
        const PER_PAGE = 15;

        function applyFilters() {
            const from = document.getElementById('filter-from').value;
            const to = document.getElementById('filter-to').value;
            const seller = document.getElementById('filter-seller').value;
            const pay = document.getElementById('filter-pay').value;
            filtered = allSales.filter(s => {
                const d = new Date(s.date);
                if (from && d < new Date(from)) return false;
                if (to && d > new Date(to + 'T23:59:59')) return false;
                if (seller && s.seller !== seller) return false;
                if (pay && s.payMethod !== pay) return false;
                return true;
            });
            currentPage = 1;
            renderTable();
        }

        function clearFilters() {
            document.getElementById('filter-from').value = '';
            document.getElementById('filter-to').value = '';
            document.getElementById('filter-seller').value = '';
            document.getElementById('filter-pay').value = '';
            filtered = [...allSales];
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const total = filtered.reduce((s, x) => s + x.total, 0);
            document.getElementById('sum-total').textContent = formatCLP(total);
            document.getElementById('sum-count').textContent = filtered.length;
            document.getElementById('sum-avg').textContent = filtered.length ? formatCLP(total / filtered.length) : '$0';

            const start = (currentPage - 1) * PER_PAGE;
            const page = filtered.slice(start, start + PER_PAGE);
            const tbody = document.getElementById('sales-tbody');
            tbody.innerHTML = page.map(s => `
      <tr onclick="toggleDetail('${s.id}')" style="cursor:pointer;">
        <td><span class="text-muted" style="font-size:0.78rem;">${s.id.slice(0, 10)}</span></td>
        <td>${formatDateShort(s.date)}</td>
        <td>${s.seller}</td>
        <td>
          ${s.items.map(i => `<span class="badge badge-blue" style="margin:2px;">${i.emoji} ${i.name} x${i.qty}</span>`).join('')}
        </td>
        <td class="fw-bold text-cyan">${formatCLP(s.total)}</td>
        <td>${s.payMethod}</td>
        <td><span class="badge badge-success">${s.status}</span></td>
      </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--gray-600);">Sin resultados</td></tr>';

            // Pagination
            const totalPages = Math.ceil(filtered.length / PER_PAGE);
            const pag = document.getElementById('pagination');
            pag.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-ghost'}`;
                btn.textContent = i;
                btn.onclick = () => { currentPage = i; renderTable(); };
                pag.appendChild(btn);
            }
        }

        function showTab(tab) {
            const tabs = ['ventas', 'vendedores'];
            tabs.forEach(t => {
                document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById(`tab-${t}`);
                if (btn) { btn.className = `btn btn-sm ${t === tab ? 'btn-primary' : 'btn-ghost'}`; }
            });
            if (tab === 'vendedores') renderSellerView();
        }

        function renderSellerView() {
            const data = getSalesBySeller();
            const container = document.getElementById('seller-cards');
            const sellers = Object.entries(data).sort((a, b) => b[1].total - a[1].total);
            container.innerHTML = sellers.map(([name, d], i) => `
      <div class="card-elevated" style="position:relative;overflow:hidden;">
        <div style="position:absolute;top:16px;right:16px;font-size:1.8rem;">${['ü•á', 'ü•à', 'ü•â'][i] || 'üèÖ'}</div>
        <div style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">${name}</div>
        <div class="kpi-label">Total vendido</div>
        <div class="text-cyan fw-bold" style="font-size:1.5rem;margin-bottom:12px;">${formatCLP(d.total)}</div>
        <div style="display:flex;gap:16px;">
          <div><div class="kpi-label">N¬∫ ventas</div><div class="fw-bold">${d.count}</div></div>
          <div><div class="kpi-label">Ticket prom.</div><div class="fw-bold">${formatCLP(d.total / d.count)}</div></div>
        </div>
      </div>
    `).join('');

            const sellerCtx = document.getElementById('sellerChart').getContext('2d');
            if (window._sellerChart) window._sellerChart.destroy();
            window._sellerChart = new Chart(sellerCtx, {
                type: 'bar',
                data: {
                    labels: sellers.map(s => s[0]),
                    datasets: [{
                        label: 'Ventas ($)',
                        data: sellers.map(s => s[1].total),
                        backgroundColor: ['#00d4ff', '#1e6aff', '#10b981'],
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', callback: v => '$' + (v / 1000).toFixed(0) + 'K' } }
                    }
                }
            });
        }

        function exportCSV() {
            const headers = ['ID', 'Fecha', 'Vendedor', 'Total', 'Pago', 'Estado'];
            const rows = filtered.map(s => [s.id, formatDateShort(s.date), s.seller, s.total, s.payMethod, s.status]);
            const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            a.download = `ventas_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            showToast('CSV exportado correctamente', 'success');
        }

        renderTable();
    </script>
</body>

</html>