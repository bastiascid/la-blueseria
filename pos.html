<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Punto de Venta ‚Äì La Blueseria</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/admin.css" />
    <style>
        .checkout-overlay-inner {
            background: var(--navy-2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 440px;
            width: 90%;
        }

        .receipt {
            font-family: monospace;
            white-space: pre;
            font-size: 0.82rem;
            color: var(--gray-400);
            background: #000;
            padding: 20px;
            border-radius: var(--radius);
            line-height: 1.6;
        }

        .empty-cart {
            text-align: center;
            padding: 48px 20px;
            color: var(--gray-600);
        }

        .empty-cart .big-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .cat-filter {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            flex-wrap: wrap;
        }

        .cat-chip {
            padding: 6px 16px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--gray-400);
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .cat-chip.active,
        .cat-chip:hover {
            background: var(--blue);
            border-color: var(--blue);
            color: #fff;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div class="admin-layout">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <svg viewBox="0 0 42 42" fill="none" width="36">
                    <circle cx="21" cy="21" r="20" fill="#1a0d04" stroke="#c8a86a" stroke-width="1.5" />
                    <path d="M16 12 L16 28 Q16 31 19 31 Q22 31 22 28 L22 22 L30 20 L30 14 L22 16 L22 12 Z"
                        fill="#c8820a" />
                    <circle cx="19" cy="30" r="2.5" fill="#f0b830" />
                </svg>
                <span>La <span style="color:var(--cyan)">Blue</span>seria</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-label">Principal</div>
                <a href="dashboard.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>Dashboard</a>
                <a href="pos.html" class="nav-item active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>Punto de Venta</a>
                <div class="nav-section-label">Reportes</div>
                <a href="ventas.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                    </svg>Historial Ventas</a>
                <a href="reportes.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                    </svg>Reportes</a>
                <div class="nav-section-label">Gesti√≥n</div>
                <a href="productos.html" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
                        <line x1="7" y1="7" x2="7.01" y2="7" />
                    </svg>Productos</a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar"><span id="sidebar-avatar-init">A</span></div>
                    <div>
                        <div class="sidebar-user-name" id="sidebar-user-name">‚Äì</div>
                        <div class="sidebar-user-role" id="sidebar-user-role">‚Äì</div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;">üö™
                    Cerrar sesi√≥n</button>
            </div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-title">üõí Punto de Venta</div>
                <div class="topbar-right">
                    <span class="topbar-time" id="topbar-time"></span>
                </div>
            </header>

            <div class="page-content" style="padding:20px;">
                <div class="pos-layout">

                    <!-- Products Panel -->
                    <div class="pos-products">
                        <div class="search-filter-bar">
                            <input class="form-control" type="text" id="pos-search" placeholder="üîç Buscar producto..."
                                style="flex:1;" />
                            <select class="form-control" id="pos-seller" style="max-width:200px;">
                                <option value="">‚Äî Vendedor ‚Äî</option>
                                <option>Carlos P√©rez</option>
                                <option>Mar√≠a L√≥pez</option>
                                <option>Juan Torres</option>
                            </select>
                        </div>
                        <div class="cat-filter" id="cat-filter">
                            <div class="cat-chip active" data-cat="Todos">Todos</div>
                            <div class="cat-chip" data-cat="Bebidas">ü•§ Bebidas</div>
                            <div class="cat-chip" data-cat="Comidas">üçî Comidas</div>
                            <div class="cat-chip" data-cat="Postres">üç¶ Postres</div>
                            <div class="cat-chip" data-cat="Extras">üßÄ Extras</div>
                        </div>
                        <br />
                        <div class="product-grid" id="product-grid"></div>
                    </div>

                    <!-- Cart Panel -->
                    <div class="pos-cart">
                        <div class="pos-cart-header">
                            <div class="flex justify-between items-center">
                                <div class="pos-cart-title">üõí Orden actual</div>
                                <span class="badge badge-blue" id="cart-count">0 items</span>
                            </div>
                        </div>

                        <div class="pos-cart-items" id="cart-items">
                            <div class="empty-cart">
                                <div class="big-icon">üõí</div>
                                <div>Agrega productos desde el men√∫</div>
                            </div>
                        </div>

                        <div class="pos-cart-footer">
                            <div class="cart-total-line">
                                <span class="cart-total-label">Subtotal</span>
                                <span id="cart-subtotal">$0</span>
                            </div>
                            <div class="cart-total-line">
                                <span class="cart-total-label">Descuento</span>
                                <span class="text-success">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="cart-total-label" style="font-weight:700;">TOTAL</span>
                                <div class="cart-grand-total" id="cart-total">$0</div>
                            </div>

                            <div class="form-group" style="margin-bottom:12px;">
                                <select class="form-control" id="pay-method">
                                    <option value="Efectivo">üíµ Efectivo</option>
                                    <option value="Tarjeta">üí≥ Tarjeta</option>
                                    <option value="Transferencia">üì± Transferencia</option>
                                </select>
                            </div>

                            <div id="cash-section" style="margin-bottom:12px;">
                                <div class="form-group">
                                    <input class="form-control" type="number" id="cash-received"
                                        placeholder="Monto recibido ($)" min="0" />
                                </div>
                                <div class="cart-total-line" style="margin-top:8px;">
                                    <span class="cart-total-label">Vuelto</span>
                                    <span class="text-success fw-bold" id="change-amount">$0</span>
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%;justify-content:center;"
                                id="checkout-btn">
                                ‚úÖ Completar Venta
                            </button>
                            <button class="btn btn-ghost btn-sm"
                                style="width:100%;justify-content:center;margin-top:8px;" id="clear-cart-btn">
                                üóë Limpiar carrito
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Success Overlay -->
    <div class="overlay" id="receipt-overlay">
        <div class="checkout-overlay-inner">
            <h2 style="text-align:center;margin-bottom:20px;">‚úÖ Venta Completada</h2>
            <pre class="receipt" id="receipt-content"></pre>
            <div style="display:flex;gap:12px;margin-top:20px;">
                <button onclick="window.print()" class="btn btn-outline" style="flex:1;justify-content:center;">üñ®
                    Imprimir</button>
                <button onclick="closeReceipt()" class="btn btn-primary" style="flex:1;justify-content:center;">Nueva
                    Venta</button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script>
        requireAuth();
        populateSidebar();
        startClock();

        let cart = [];
        let currentCat = 'Todos';

        // Render products
        function renderProducts() {
            const search = document.getElementById('pos-search').value.toLowerCase();
            const all = getProducts().filter(p => p.active);
            const filtered = all.filter(p =>
                (currentCat === 'Todos' || p.category === currentCat) &&
                p.name.toLowerCase().includes(search)
            );
            document.getElementById('product-grid').innerHTML = filtered.map(p => `
      <div class="product-card" onclick="addToCart('${p.id}')">
        <div class="product-emoji">${p.emoji}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-price">${formatCLP(p.price)}</div>
        <div class="product-cat">${p.category}</div>
      </div>
    `).join('') || '<div style="grid-column:1/-1;text-align:center;color:var(--gray-600);padding:40px;">No hay productos</div>';
        }

        // Category filter
        document.querySelectorAll('.cat-chip').forEach(c => {
            c.addEventListener('click', () => {
                document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
                c.classList.add('active');
                currentCat = c.dataset.cat;
                renderProducts();
            });
        });

        document.getElementById('pos-search').addEventListener('input', renderProducts);

        // Cart logic
        function addToCart(id) {
            const p = getProducts().find(x => x.id === id);
            const item = cart.find(c => c.id === id);
            if (item) { item.qty++; }
            else { cart.push({ ...p, qty: 1 }); }
            renderCart();
            showToast(`${p.emoji} ${p.name} agregado`, 'success');
        }

        function removeFromCart(id) {
            cart = cart.filter(c => c.id !== id);
            renderCart();
        }

        function changeQty(id, delta) {
            const item = cart.find(c => c.id === id);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) removeFromCart(id);
            else renderCart();
        }

        function renderCart() {
            const total = cart.reduce((s, c) => s + c.price * c.qty, 0);
            document.getElementById('cart-count').textContent = `${cart.reduce((s, c) => s + c.qty, 0)} items`;
            document.getElementById('cart-subtotal').textContent = formatCLP(total);
            document.getElementById('cart-total').textContent = formatCLP(total);
            updateChange();

            const itemsEl = document.getElementById('cart-items');
            if (cart.length === 0) {
                itemsEl.innerHTML = '<div class="empty-cart"><div class="big-icon">üõí</div><div>Agrega productos desde el men√∫</div></div>';
                return;
            }
            itemsEl.innerHTML = cart.map(item => `
      <div class="cart-item">
        <div class="cart-item-emoji">${item.emoji}</div>
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-price">${formatCLP(item.price)} c/u</div>
        </div>
        <div class="cart-qty-control">
          <button class="qty-btn" onclick="changeQty('${item.id}',-1)">‚àí</button>
          <span class="qty-display">${item.qty}</span>
          <button class="qty-btn" onclick="changeQty('${item.id}',1)">+</button>
        </div>
        <span class="cart-item-remove" onclick="removeFromCart('${item.id}')">‚úï</span>
      </div>
    `).join('');
        }

        // Payment
        document.getElementById('pay-method').addEventListener('change', function () {
            document.getElementById('cash-section').style.display = this.value === 'Efectivo' ? 'block' : 'none';
        });

        function updateChange() {
            const total = cart.reduce((s, c) => s + c.price * c.qty, 0);
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = Math.max(0, received - total);
            document.getElementById('change-amount').textContent = formatCLP(change);
        }
        document.getElementById('cash-received').addEventListener('input', updateChange);

        // Checkout
        document.getElementById('checkout-btn').addEventListener('click', () => {
            if (cart.length === 0) { showToast('El carrito est√° vac√≠o', 'error'); return; }
            const seller = document.getElementById('pos-seller').value || 'Sin asignar';
            const payMethod = document.getElementById('pay-method').value;
            const total = cart.reduce((s, c) => s + c.price * c.qty, 0);

            const sale = saveSale({
                date: new Date().toISOString(),
                seller,
                items: cart.map(c => ({ id: c.id, name: c.name, price: c.price, qty: c.qty, emoji: c.emoji })),
                total,
                payMethod,
                status: 'Completada',
            });

            // Generate receipt
            const now = new Date().toLocaleString('es-CL');
            let receipt = `
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        LA BLUESERIA
    Fuente de Soda & Shoper√≠a
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Fecha: ${now}
  Boleta N¬∞: ${sale.id}
  Vendedor: ${seller}
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  PRODUCTO            CANT   TOTAL
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
            cart.forEach(item => {
                const name = item.name.padEnd(18).slice(0, 18);
                const qty = String(item.qty).padStart(4);
                const tot = formatCLP(item.price * item.qty).padStart(8);
                receipt += `  ${name} ${qty}  ${tot}\n`;
            });
            receipt += `  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  TOTAL:              ${formatCLP(total).padStart(16)}
  M√©todo de pago: ${payMethod}
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ¬°Gracias por tu visita!
       Vuelve pronto üéµ
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
            document.getElementById('receipt-content').textContent = receipt;
            document.getElementById('receipt-overlay').classList.add('active');
            cart = [];
            renderCart();
            showToast('¬°Venta registrada exitosamente!', 'success');
        });

        document.getElementById('clear-cart-btn').addEventListener('click', () => {
            cart = [];
            renderCart();
        });

        function closeReceipt() {
            document.getElementById('receipt-overlay').classList.remove('active');
        }

        renderProducts();
    </script>
</body>

</html>