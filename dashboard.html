<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ‚Äì La Blueseria</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div id="toast-container"></div>
    <div class="admin-layout">

        <!-- ===== SIDEBAR ===== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <svg viewBox="0 0 48 36" fill="none" xmlns="http://www.w3.org/2000/svg" width="56" height="42">
                    <rect x="2" y="5" width="44" height="26" rx="3" fill="#1a0d04" stroke="#c8a86a"
                        stroke-width="1.2" />
                    <rect x="4" y="7" width="40" height="22" rx="2" fill="none" stroke="#d4a020" stroke-width="0.6"
                        opacity="0.7" />
                    <path d="M2 14 Q0 14 0 18 Q0 22 2 22" fill="#1a0d04" stroke="#c8a86a" stroke-width="1" />
                    <path d="M46 14 Q48 14 48 18 Q48 22 46 22" fill="#1a0d04" stroke="#c8a86a" stroke-width="1" />
                    <polygon points="24,2 26,5 24,8 22,5" fill="none" stroke="#c8a86a" stroke-width="0.8" />
                    <polygon points="24,28 26,31 24,34 22,31" fill="none" stroke="#c8a86a" stroke-width="0.8" />
                    <text x="24" y="22" text-anchor="middle" font-family="Georgia,serif" font-weight="bold"
                        font-size="11" fill="#f0b830" letter-spacing="1">BLUE</text>
                    <text x="24" y="11" text-anchor="middle" font-family="Arial,sans-serif" font-size="4.5"
                        fill="#fdf5e8" letter-spacing="1">FUENTE DE SODA</text>
                    <text x="24" y="33" text-anchor="middle" font-family="Arial,sans-serif" font-size="4.5"
                        fill="#fdf5e8" letter-spacing="1">SHOPER√çA</text>
                </svg>
                <span style="font-family:'Oswald',sans-serif;letter-spacing:0.04em;">La <span
                        style="color:var(--cyan)">BLUESERIA</span></span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section-label">Principal</div>
                <a href="dashboard.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    Dashboard
                </a>
                <a href="pos.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>
                    Punto de Venta
                </a>

                <div class="nav-section-label">Reportes</div>
                <a href="ventas.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                    </svg>
                    Historial Ventas
                </a>
                <a href="reportes.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10" />
                        <line x1="12" y1="20" x2="12" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="14" />
                    </svg>
                    Reportes
                </a>

                <div class="nav-section-label">Gesti√≥n</div>
                <a href="productos.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
                        <line x1="7" y1="7" x2="7.01" y2="7" />
                    </svg>
                    Productos
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar"><span id="sidebar-avatar-init">A</span></div>
                    <div>
                        <div class="sidebar-user-name" id="sidebar-user-name">‚Äì</div>
                        <div class="sidebar-user-role" id="sidebar-user-role">‚Äì</div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;">
                    üö™ Cerrar sesi√≥n
                </button>
            </div>
        </aside>

        <!-- ===== MAIN ===== -->
        <div class="main-content">
            <header class="topbar">
                <div class="topbar-title">üìä Dashboard</div>
                <div class="topbar-right">
                    <span class="topbar-time" id="topbar-time"></span>
                    <div class="topbar-notif">üîî<span class="notif-dot"></span></div>
                    <a href="index.html" class="btn btn-ghost btn-sm">üåê Ver web</a>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <h1 class="page-title">¬°Bienvenido! üëã</h1>
                    <p class="page-subtitle" id="greeting-date">‚Äì</p>
                </div>

                <!-- KPIs -->
                <div class="kpi-grid" id="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Ventas del d√≠a</div>
                        <div class="kpi-value text-cyan" id="kpi-hoy">$0</div>
                        <div class="kpi-change up" id="kpi-hoy-count">0 transacciones</div>
                        <div class="kpi-icon" style="background:rgba(0,212,255,0.1);">üí∞</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ventas del mes</div>
                        <div class="kpi-value text-blue" id="kpi-mes">$0</div>
                        <div class="kpi-change up" id="kpi-mes-count">0 ventas</div>
                        <div class="kpi-icon" style="background:rgba(30,106,255,0.1);">üìÖ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ticket promedio</div>
                        <div class="kpi-value" id="kpi-ticket">$0</div>
                        <div class="kpi-change up">‚Üë vs ayer</div>
                        <div class="kpi-icon" style="background:rgba(16,185,129,0.1);">üßæ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Vendedor del d√≠a</div>
                        <div class="kpi-value" id="kpi-vendedor" style="font-size:1.1rem;">‚Äì</div>
                        <div class="kpi-change up" id="kpi-vendedor-total">‚Äì</div>
                        <div class="kpi-icon" style="background:rgba(245,158,11,0.1);">‚≠ê</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Ventas por d√≠a</div>
                        <div class="chart-subtitle">√öltimos 7 d√≠as</div>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Ventas por categor√≠a</div>
                        <div class="chart-subtitle">Este mes</div>
                        <div class="chart-container"><canvas id="catChart"></canvas></div>
                    </div>
                </div>

                <!-- Recent Sales Table -->
                <div class="card-elevated">
                    <div class="flex justify-between items-center mb-4" style="margin-bottom:20px;">
                        <h3 style="font-size:1rem;font-weight:700;">üßæ √öltimas ventas</h3>
                        <a href="ventas.html" class="btn btn-outline btn-sm">Ver todas</a>
                    </div>
                    <div class="table-wrap">
                        <table id="recent-sales-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Vendedor</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Pago</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sales-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script>
        requireAuth();
        populateSidebar();
        startClock();

        // Greeting
        const now = new Date();
        document.getElementById('greeting-date').textContent =
            now.toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // KPIs
        const todaySales = getSalesToday();
        const monthSales = getSalesThisMonth();
        const todayTotal = todaySales.reduce((a, s) => a + s.total, 0);
        const monthTotal = monthSales.reduce((a, s) => a + s.total, 0);
        const avgTicket = monthSales.length ? monthTotal / monthSales.length : 0;

        document.getElementById('kpi-hoy').textContent = formatCLP(todayTotal);
        document.getElementById('kpi-hoy-count').textContent = `${todaySales.length} transacciones`;
        document.getElementById('kpi-mes').textContent = formatCLP(monthTotal);
        document.getElementById('kpi-mes-count').textContent = `${monthSales.length} ventas`;
        document.getElementById('kpi-ticket').textContent = formatCLP(avgTicket);

        const sellers = getSalesBySeller();
        const topSeller = Object.entries(sellers).sort((a, b) => b[1].total - a[1].total)[0];
        if (topSeller) {
            document.getElementById('kpi-vendedor').textContent = topSeller[0];
            document.getElementById('kpi-vendedor-total').textContent = `${formatCLP(topSeller[1].total)} este mes`;
        }

        // Chart: Sales by day
        const dayData = getSalesByDay(7);
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: dayData.map(d => d.label),
                datasets: [{
                    label: 'Ventas ($)',
                    data: dayData.map(d => d.total),
                    backgroundColor: dayData.map((_, i) => i === dayData.length - 1 ? '#f0b830' : 'rgba(200,130,10,0.55)'),
                    borderRadius: 8, borderSkipped: false,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', callback: v => '$' + (v / 1000).toFixed(0) + 'K' } }
                }
            }
        });

        // Chart: by category
        const catData = getSalesByCategory();
        const catCtx = document.getElementById('catChart').getContext('2d');
        new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catData),
                datasets: [{
                    data: Object.values(catData),
                    backgroundColor: ['#c8820a', '#f0b830', '#2ecc71', '#e09a20'],
                    borderWidth: 0, hoverOffset: 8,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#c8a86a', padding: 16, usePointStyle: true, pointStyleWidth: 8 }
                    }
                }
            }
        });

        // Recent sales table
        const recents = getSales().slice(0, 10);
        const tbody = document.getElementById('recent-sales-body');
        tbody.innerHTML = recents.map(s => `
    <tr>
      <td><span class="text-muted" style="font-size:0.78rem;">${s.id}</span></td>
      <td>${formatDateShort(s.date)}</td>
      <td>${s.seller}</td>
      <td><span class="badge badge-blue">${s.items.length} item(s)</span></td>
      <td class="fw-bold text-cyan">${formatCLP(s.total)}</td>
      <td>${s.payMethod}</td>
      <td><span class="badge badge-success">${s.status}</span></td>
    </tr>
  `).join('');
    </script>
</body>

</html>